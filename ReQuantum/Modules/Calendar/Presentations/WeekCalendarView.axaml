<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewModels="clr-namespace:ReQuantum.ViewModels"
             xmlns:presentations="clr-namespace:ReQuantum.Modules.Calendar.Presentations"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="ReQuantum.Views.WeekCalendarView"
             x:DataType="presentations:WeekCalendarViewModel">
  <Design.DataContext>
    <presentations:WeekCalendarViewModel />
  </Design.DataContext>

  <Grid>
    <!-- 移动端布局 -->
    <Border IsVisible="{Binding !WindowService.IsDesktopMode}"
            Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
            BorderThickness="0"
            CornerRadius="8">
      <Grid RowDefinitions="Auto,*" ColumnDefinitions="50,*">
      
      <!-- 左上角空白 -->
      <Border Grid.Row="0" Grid.Column="0"/>
      
      <!-- 星期标题行 -->
      <ItemsControl Grid.Row="0" Grid.Column="1" ItemsSource="{Binding WeekDays}">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate>
            <UniformGrid Columns="7"/>
          </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
        <ItemsControl.ItemTemplate>
          <DataTemplate DataType="presentations:WeekDay">
            <Button Background="Transparent"
                    BorderThickness="0"
                    Padding="8"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    Cursor="Hand"
                    Command="{Binding SelectCommand}">
              <Button.Styles>
                <Style Selector="Button:pointerover /template/ ContentPresenter">
                  <Setter Property="Background" Value="{DynamicResource RegionHoveredBrush}"/>
                </Style>
              </Button.Styles>
              <StackPanel Spacing="4">
                <TextBlock Text="{Binding DayOfWeek}" 
                         HorizontalAlignment="Center" 
                         FontSize="12" 
                         Opacity="0.6" 
                         FontWeight="SemiBold"/>
                <Border Background="Transparent"
                        BorderThickness="0"
                        CornerRadius="16"
                        Padding="8,4"
                        HorizontalAlignment="Center">
                  <TextBlock Text="{Binding Day}"
                           FontSize="12"
                           FontWeight="Normal"/>
                </Border>
              </StackPanel>
            </Button>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>

      <!-- 时间线网格（使用 ScrollViewer 包装以支持滚动）-->
      <ScrollViewer Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" 
                    VerticalScrollBarVisibility="Auto" 
                    HorizontalScrollBarVisibility="Disabled">
        <Grid ColumnDefinitions="50,*" Height="780" x:Name="MobileTimeGrid">
          
          <!-- 左侧时间列 -->
          <ItemsControl Grid.Column="0" ItemsSource="{x:Static presentations:CalendarConverters.Hours24}">
            <ItemsControl.ItemTemplate>
              <DataTemplate DataType="x:Int32">
                <Border Height="30" 
                        BorderThickness="0,1,0,0"
                        BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                        Padding="4,2,0,0">
                  <TextBlock Text="{Binding Converter={x:Static presentations:CalendarConverters.HourToTimeStringConverter}}"
                           FontSize="10"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           VerticalAlignment="Top"/>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
          
          <!-- 右侧7天列 -->
          <Grid Grid.Column="1">
            <!-- 横线背景层（连续不断开）-->
            <ItemsControl ItemsSource="{x:Static presentations:CalendarConverters.Hours24}">
              <ItemsControl.ItemTemplate>
                <DataTemplate DataType="x:Int32">
                  <Border Height="30" 
                          BorderThickness="0,1,0,0"
                          BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"/>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
            
            <!-- 7天列（带竖线分隔）-->
            <ItemsControl ItemsSource="{Binding WeekDays}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <UniformGrid Columns="7"/>
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              
              <ItemsControl.ItemTemplate>
                <DataTemplate DataType="presentations:WeekDay">
                  <Button Background="Transparent"
                          BorderThickness="1,0,0,0"
                          BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                          Padding="4"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          HorizontalContentAlignment="Stretch"
                          VerticalContentAlignment="Stretch"
                          Cursor="Hand"
                          Command="{Binding SelectCommand}">
                    <Button.Styles>
                      <!-- 移除悬浮背景色，避免覆盖横线 -->
                      <Style Selector="Button:pointerover">
                        <Setter Property="Opacity" Value="0.8"/>
                      </Style>
                      <!-- 选中状态使用边框而不是背景 -->
                      <Style Selector="Button">
                        <Setter Property="BorderBrush" Value="{Binding IsSelected, Converter={x:Static presentations:CalendarConverters.IsSelectedToBorderBrushConverter}}"/>
                        <Setter Property="BorderThickness" Value="{Binding IsSelected, Converter={x:Static presentations:CalendarConverters.WeekDaySelectedBorderThicknessConverter}}"/>
                      </Style>
                    </Button.Styles>
                    <!-- 时间线容器（24小时+2小时缓冲，每小时30像素 = 780px）-->
                    <Grid Height="780">
                  
                  <!-- 事项层（使用 Canvas 绝对定位）-->
                  <ItemsControl ItemsSource="{Binding TimelineItems}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <Canvas/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate DataType="presentations:WeekTimelineItem">
                        <Grid x:Name="WeekTimelineItemGrid"
                              Width="{Binding Bounds.Width, RelativeSource={RelativeSource AncestorType=Button}}">
                          <!-- 待办事项（红色区块，宽度95%，居左）-->
                          <Border IsVisible="{Binding IsTodo}"
                                  Background="{DynamicResource LightTodoBrush}"
                                  BorderBrush="{DynamicResource TodoBrush}"
                                  BorderThickness="0,3,0,0"
                                  CornerRadius="0"
                                  Height="{Binding Height, Converter={x:Static presentations:CalendarConverters.HourToPixelConverter}}"
                                  HorizontalAlignment="Left"
                                  Width="{Binding #WeekTimelineItemGrid.Bounds.Width, Converter={x:Static presentations:CalendarConverters.WidthTo95PercentConverter}}">
                            <Border.RenderTransform>
                              <TranslateTransform Y="{Binding TopPosition, Converter={x:Static presentations:CalendarConverters.HourToPixelConverter}}"/>
                            </Border.RenderTransform>
                            <TextBlock Text="{Binding Content}"
                                     FontSize="10"
                                     Foreground="{DynamicResource PrimaryTextBrush}"
                                     FontWeight="Medium"
                                     TextTrimming="CharacterEllipsis"
                                     VerticalAlignment="Center"/>
                          </Border>
                          
                          <!-- 日程事项（蓝色区块，宽度95%，居左）-->
                          <Border IsVisible="{Binding IsEvent}"
                                  Background="{DynamicResource LightEventBrush}"
                                  BorderBrush="{DynamicResource EventBrush}"
                                  BorderThickness="0,3,0,0"
                                  CornerRadius="0"
                                  HorizontalAlignment="Left"
                                  Width="{Binding #WeekTimelineItemGrid.Bounds.Width, Converter={x:Static presentations:CalendarConverters.WidthTo95PercentConverter}}"
                                  Height="{Binding Height, Converter={x:Static presentations:CalendarConverters.HourToPixelConverter}}">
                            <Border.RenderTransform>
                              <TranslateTransform Y="{Binding TopPosition, Converter={x:Static presentations:CalendarConverters.HourToPixelConverter}}"/>
                            </Border.RenderTransform>
                            <TextBlock Text="{Binding Content}"
                                     FontSize="10"
                                     Foreground="{DynamicResource PrimaryTextBrush}"
                                     FontWeight="Medium"
                                     TextWrapping="Wrap"
                                     VerticalAlignment="Center"/>
                          </Border>
                        </Grid>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                    </Grid>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </Grid>
        </Grid>
      </ScrollViewer>
      
      </Grid>
    </Border>

    <!-- 桌面端布局 -->
    <Border IsVisible="{Binding WindowService.IsDesktopMode}"
            Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
            BorderThickness="0"
            CornerRadius="8">
      <Grid RowDefinitions="Auto,*" ColumnDefinitions="60,*">
              
              <!-- 左上角空白 -->
              <Border Grid.Row="0" Grid.Column="0"/>
              
              <!-- 星期标题行 -->
              <ItemsControl Grid.Row="0" Grid.Column="1" ItemsSource="{Binding WeekDays}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <UniformGrid Columns="7"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate DataType="presentations:WeekDay">
                    <Button Background="Transparent"
                            BorderThickness="0"
                            Padding="8"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            Cursor="Hand"
                            Command="{Binding SelectCommand}">
                      <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                          <Setter Property="Background" Value="{DynamicResource RegionHoveredBrush}"/>
                        </Style>
                      </Button.Styles>
                      <StackPanel Spacing="4">
                        <TextBlock Text="{Binding DayOfWeek}" 
                                 HorizontalAlignment="Center" 
                                 FontSize="16" 
                                 Opacity="0.6" 
                                 FontWeight="SemiBold"/>
                        <Border Background="{Binding IsToday, Converter={x:Static presentations:CalendarConverters.IsTodayToBackgroundConverter}}"
                                BorderThickness="{Binding IsSelected, Converter={x:Static presentations:CalendarConverters.IsSelectedToBorderThicknessConverter}}"
                                BorderBrush="{Binding IsSelected, Converter={x:Static presentations:CalendarConverters.IsSelectedToBorderBrushConverter}}"
                                CornerRadius="20"
                                Padding="12,6"
                                HorizontalAlignment="Center">
                          <TextBlock Text="{Binding Day}"
                                   FontSize="20"
                                   Foreground="{Binding IsToday, Converter={x:Static presentations:CalendarConverters.IsTodayToForegroundConverter}}"
                                   FontWeight="{Binding IsToday, Converter={x:Static presentations:CalendarConverters.IsTodayToFontWeightConverter}}"/>
                        </Border>
                      </StackPanel>
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>

              <!-- 时间线网格（桌面端不限高）-->
              <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" ColumnDefinitions="60,*" x:Name="DesktopTimeGrid">
                
                <!-- 左侧时间列 -->
                <ItemsControl Grid.Column="0" ItemsSource="{x:Static presentations:CalendarConverters.Hours24}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="x:Int32">
                      <Border Height="40" 
                              BorderThickness="0,1,0,0"
                              BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                              Padding="4,2,0,0">
                        <TextBlock Text="{Binding Converter={x:Static presentations:CalendarConverters.HourToTimeStringConverter}}"
                                 FontSize="14"
                                 Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                 VerticalAlignment="Top"/>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- 右侧7天列 -->
                <Grid Grid.Column="1">
                  <!-- 横线背景层 -->
                  <ItemsControl ItemsSource="{x:Static presentations:CalendarConverters.Hours24}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate DataType="x:Int32">
                        <Border Height="40" 
                                BorderThickness="0,1,0,0"
                                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"/>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                  
                  <!-- 7天列 -->
                  <ItemsControl ItemsSource="{Binding WeekDays}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <UniformGrid Columns="7"/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    
                    <ItemsControl.ItemTemplate>
                      <DataTemplate DataType="presentations:WeekDay">
                        <Button Background="Transparent"
                                BorderThickness="1,0,0,0"
                                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                                Padding="4"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                HorizontalContentAlignment="Stretch"
                                VerticalContentAlignment="Stretch"
                                Cursor="Hand"
                                Command="{Binding SelectCommand}">
                          <Button.Styles>
                            <Style Selector="Button:pointerover">
                              <Setter Property="Opacity" Value="0.8"/>
                            </Style>
                            <Style Selector="Button">
                              <Setter Property="BorderBrush" Value="{Binding IsSelected, Converter={x:Static presentations:CalendarConverters.IsSelectedToBorderBrushConverter}}"/>
                              <Setter Property="BorderThickness" Value="{Binding IsSelected, Converter={x:Static presentations:CalendarConverters.WeekDaySelectedBorderThicknessConverter}}"/>
                            </Style>
                          </Button.Styles>
                          <!-- 时间线容器（桌面端：24小时+2小时缓冲，每小时40像素 = 1040px）-->
                          <Grid Height="1040">
                        
                        <!-- 事项层 -->
                        <ItemsControl ItemsSource="{Binding TimelineItems}">
                          <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                              <Canvas/>
                            </ItemsPanelTemplate>
                          </ItemsControl.ItemsPanel>
                          <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="presentations:WeekTimelineItem">
                              <Grid x:Name="WeekTimelineItemGrid"
                                    Width="{Binding Bounds.Width, RelativeSource={RelativeSource AncestorType=Button}}">
                                <!-- 待办事项 -->
                                <Border IsVisible="{Binding IsTodo}"
                                        Background="{DynamicResource LightTodoBrush}"
                                        BorderBrush="{DynamicResource TodoBrush}"
                                        BorderThickness="0,3,0,0"
                                        CornerRadius="0"
                                        Height="{Binding Height, Converter={x:Static presentations:CalendarConverters.HourToPixelDesktopConverter}}"
                                        HorizontalAlignment="Left"
                                        Width="{Binding Bounds.Width, 
                                            Converter={x:Static presentations:CalendarConverters.WidthTo95PercentConverter}, 
                                            RelativeSource={RelativeSource AncestorType=Button}}">
                                  <Border.RenderTransform>
                                    <TranslateTransform Y="{Binding TopPosition, Converter={x:Static presentations:CalendarConverters.HourToPixelDesktopConverter}}"/>
                                  </Border.RenderTransform>
                                  <TextBlock Text="{Binding Content}"
                                           FontSize="13"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           FontWeight="Medium"
                                           TextTrimming="CharacterEllipsis"
                                           VerticalAlignment="Center"/>
                                </Border>
                                
                                <!-- 日程事项 -->
                                <Border IsVisible="{Binding IsEvent}"
                                        Background="{DynamicResource LightEventBrush}"
                                        BorderBrush="{DynamicResource EventBrush}"
                                        BorderThickness="0,3,0,0"
                                        CornerRadius="0"
                                        HorizontalAlignment="Left"
                                        Width="{Binding #WeekTimelineItemGrid.Bounds.Width, Converter={x:Static presentations:CalendarConverters.WidthTo95PercentConverter}}"
                                        Height="{Binding Height, Converter={x:Static presentations:CalendarConverters.HourToPixelDesktopConverter}}">
                                  <Border.RenderTransform>
                                    <TranslateTransform Y="{Binding TopPosition, Converter={x:Static presentations:CalendarConverters.HourToPixelDesktopConverter}}"/>
                                  </Border.RenderTransform>
                                  <TextBlock Text="{Binding Content}"
                                           FontSize="13"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           FontWeight="Medium"
                                           TextWrapping="Wrap"
                                           VerticalAlignment="Center"/>
                                </Border>
                              </Grid>
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                          </Grid>
                        </Button>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </Grid>
        </Grid>
      </Grid>
    </Border>
  </Grid>
</UserControl>
