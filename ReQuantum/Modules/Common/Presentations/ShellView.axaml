<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:iconPacks="https://github.com/MahApps/IconPacks.Avalonia"
             xmlns:services="clr-namespace:ReQuantum.Services"
             xmlns:presentations="clr-namespace:ReQuantum.Infrastructure.Presentations"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="ReQuantum.Infrastructure.Presentations.ShellView"
             x:Name="Root"
             x:DataType="presentations:ShellViewModel">


    <Design.DataContext>
    <!-- This only sets the DataContext for the previewer in an IDE,
         to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
    <presentations:ShellViewModel />
  </Design.DataContext>

  <Grid>

      <!-- Landscape Layout: Collapsible side menu (height < width) -->
    <Grid x:Name="LandscapeLayout"
          IsVisible="{Binding Bounds, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={x:Static presentations:ShellView.IsLandscapeConverter}}">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="Auto"/>
        <ColumnDefinition Width="*"/>
      </Grid.ColumnDefinitions>
      
      <!-- Navigation Menu -->
      <Border Grid.Column="0">

          <Border.Background>
              <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                  <GradientStop Offset="0.0" Color="{DynamicResource SidebarColor}" />
                  <GradientStop Offset="1.0" Color="{DynamicResource SidebarColor2}" />
              </LinearGradientBrush>
          </Border.Background>
              <Border.OpacityMask>

    </Border.OpacityMask>
          <Border.Width>
          <MultiBinding>
            <MultiBinding.Converter>
              <presentations:BoolToWidthConverter CollapsedWidth="60" ExpandedWidth="250"/>
            </MultiBinding.Converter>
            <Binding Path="IsMenuExpanded"/>
          </MultiBinding>
        </Border.Width>
        <StackPanel Spacing="4" Margin="8">
          <!-- Header with Toggle Button -->
          <Grid Margin="0,16,0,24">
            <TextBlock Text="ReQuantum"
                       FontSize="20"
                       FontWeight="SemiBold"
                       TextWrapping="NoWrap"
                       Margin="8,0"
                       IsVisible="{Binding IsMenuExpanded}"/>
            <Button Content="{iconPacks:Material Menu}"
                    HorizontalAlignment="Right"
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="8"
                    Command="{Binding ToggleMenuCommand}"
                    ToolTip.Tip="{Binding IsMenuExpanded, Converter={x:Static presentations:ShellView.MenuTooltipConverter}}"/>
          </Grid>
          
          <!-- Navigation Menu -->
          <ListBox ItemsSource="{Binding MenuItems}"
                   SelectedItem="{Binding SelectedMenuItem}"
                   Background="Transparent"
                   BorderThickness="0">
            <ListBox.ItemTemplate>
              <DataTemplate DataType="services:MenuItem">
                <Border Padding="12,8"
                        CornerRadius="4"
                        Background="Transparent"
                        ToolTip.Tip="{Binding Title.Text}">
                  <StackPanel Orientation="Horizontal" Spacing="12">
                    <iconPacks:PackIconMaterial Kind="{Binding IconKind}"
                                               Width="18"
                                               Height="18"
                                               VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Title.Text}"
                              FontSize="14"
                              VerticalAlignment="Center"
                              TextWrapping="NoWrap"
                              IsVisible="{Binding ((presentations:ShellViewModel)DataContext).IsMenuExpanded, RelativeSource={RelativeSource AncestorType=UserControl}, FallbackValue=False}"/>
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ListBox.ItemTemplate>
            <ListBox.Styles>
              <Style Selector="ListBoxItem">
                <Setter Property="Padding" Value="4"/>
                <Setter Property="Margin" Value="0,2"/>
              </Style>
              <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                <Setter Property="Background" Value="{DynamicResource SidebarSelectedBrush}"/>
              </Style>
              <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                <Setter Property="Background" Value="{DynamicResource SidebarSelectedHoverBrush}"/>
              </Style>
            </ListBox.Styles>
          </ListBox>
        </StackPanel>
      </Border>
      <!-- Main Content -->
      <ContentControl Grid.Column="1" 
                      Margin="20">
              <TransitioningContentControl Content="{Binding CurrentViewModel}">
                  <TransitioningContentControl.PageTransition>
                      <!-- 设置页面切换时的过渡效果，如淡入淡出或侧滑 -->
                      <CrossFade Duration="0:0:0.18" />
                  </TransitioningContentControl.PageTransition>
              </TransitioningContentControl>
      </ContentControl>

    </Grid>

    <!-- Portrait Layout: Bottom navigation with 4 buttons (height >= width) -->
    <Grid x:Name="PortraitLayout"
          IsVisible="{Binding $parent[UserControl].Bounds, Converter={x:Static presentations:ShellView.IsPortraitConverter}}">
      <Grid.RowDefinitions>
        <RowDefinition Height="*"/>
        <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>
      
      <!-- Main Content -->
      <ContentControl Grid.Row="0"
                      Content="{Binding CurrentViewModel}"
                      Margin="16"/>
      
      <!-- Bottom Navigation Bar with 4 buttons -->
      <Border Grid.Row="1"
              Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
              BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
              BorderThickness="0,1,0,0">
        <Border.Effect>
          <DropShadowEffect BlurRadius="10" 
                           OffsetY="-2" 
                           Opacity="0.2"/>
        </Border.Effect>
        
        <!-- Container with max width and centered -->
        <Grid HorizontalAlignment="Stretch" MaxWidth="600">
          <Grid Height="60" Margin="20,0">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Button 1 -->
            <ContentControl Grid.Column="0" 
                          Content="{Binding TopMenuItems, Converter={x:Static presentations:ShellView.GetItemAtIndexConverter}, ConverterParameter=0}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
              <ContentControl.ContentTemplate>
                <DataTemplate DataType="services:MenuItem">
                  <Button Background="Transparent"
                          BorderThickness="0"
                          Padding="4"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          Command="{Binding SelectedCommand, FallbackValue={x:Null}}"
                          CommandParameter="{Binding}">
                    <StackPanel Spacing="2" HorizontalAlignment="Center" VerticalAlignment="Center">
                      <iconPacks:PackIconMaterial Kind="{Binding IconKind}"
                                                 Width="20"
                                                 Height="20"
                                                 HorizontalAlignment="Center"/>
                      <TextBlock Text="{Binding Title.Text}"
                                FontSize="10"
                                TextAlignment="Center"
                                TextWrapping="Wrap"
                                MaxWidth="60"/>
                    </StackPanel>
                  </Button>
                </DataTemplate>
              </ContentControl.ContentTemplate>
            </ContentControl>
            
            <!-- Button 2 -->
            <ContentControl Grid.Column="1" 
                          Content="{Binding TopMenuItems, Converter={x:Static presentations:ShellView.GetItemAtIndexConverter}, ConverterParameter=1}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
              <ContentControl.ContentTemplate>
                <DataTemplate DataType="services:MenuItem">
                  <Button Background="Transparent"
                          BorderThickness="0"
                          Padding="4"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          Command="{Binding SelectedCommand, FallbackValue={x:Null}}"
                          CommandParameter="{Binding}">
                    <StackPanel Spacing="2" HorizontalAlignment="Center" VerticalAlignment="Center">
                      <iconPacks:PackIconMaterial Kind="{Binding IconKind}"
                                                 Width="20"
                                                 Height="20"
                                                 HorizontalAlignment="Center"/>
                      <TextBlock Text="{Binding Title.Text}"
                                FontSize="10"
                                TextAlignment="Center"
                                TextWrapping="Wrap"
                                MaxWidth="60"/>
                    </StackPanel>
                  </Button>
                </DataTemplate>
              </ContentControl.ContentTemplate>
            </ContentControl>
            
            <!-- Button 3 -->
            <ContentControl Grid.Column="2" 
                          Content="{Binding TopMenuItems, Converter={x:Static presentations:ShellView.GetItemAtIndexConverter}, ConverterParameter=2}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
              <ContentControl.ContentTemplate>
                <DataTemplate DataType="services:MenuItem">
                  <Button Background="Transparent"
                          BorderThickness="0"
                          Padding="4"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          Command="{Binding SelectedCommand, FallbackValue={x:Null}}"
                          CommandParameter="{Binding}">
                    <StackPanel Spacing="2" HorizontalAlignment="Center" VerticalAlignment="Center">
                      <iconPacks:PackIconMaterial Kind="{Binding IconKind}"
                                                 Width="20"
                                                 Height="20"
                                                 HorizontalAlignment="Center"/>
                      <TextBlock Text="{Binding Title.Text}"
                                FontSize="10"
                                TextAlignment="Center"
                                TextWrapping="Wrap"
                                MaxWidth="60"/>
                    </StackPanel>
                  </Button>
                </DataTemplate>
              </ContentControl.ContentTemplate>
            </ContentControl>
            
            <!-- Menu Button (4th position) -->
            <Button Grid.Column="3"
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="4"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    Click="MenuFabButton_OnClick">
              <StackPanel Spacing="2" HorizontalAlignment="Center" VerticalAlignment="Center">
                <iconPacks:PackIconMaterial Kind="ViewList"
                                           Width="20"
                                           Height="20"
                                           HorizontalAlignment="Center"/>
                <TextBlock Text="{Binding Localizer[Menu]}"
                          FontSize="10"
                          TextAlignment="Center"/>
              </StackPanel>
            </Button>
          </Grid>
        </Grid>
      </Border>
      
      <!-- Popup Menu (slides up from bottom, 50% height, grid layout) -->
      <Border x:Name="MenuPopup"
              Grid.Row="0"
              Grid.RowSpan="2"
              Background="#80000000"
              IsVisible="{Binding IsMenuExpanded}"
              IsHitTestVisible="{Binding IsMenuExpanded}"
              PointerPressed="MenuOverlay_OnPointerPressed">
        <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                CornerRadius="16,16,0,0"
                VerticalAlignment="Bottom"
                Padding="16">
          <Border.Height>
            <MultiBinding>
              <MultiBinding.Converter>
                <presentations:PercentageHeightConverter Percentage="0.5"/>
              </MultiBinding.Converter>
              <Binding Path="#Root.Bounds.Height"/>
            </MultiBinding>
          </Border.Height>
          <Border.Transitions>
            <Transitions>
              <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3">
                <TransformOperationsTransition.Easing>
                  <CubicEaseOut/>
                </TransformOperationsTransition.Easing>
              </TransformOperationsTransition>
            </Transitions>
          </Border.Transitions>
          <Border.RenderTransform>
            <TranslateTransform Y="{Binding IsMenuExpanded, Converter={x:Static presentations:ShellView.MenuSlideConverter}}"/>
          </Border.RenderTransform>
          
          <Grid RowDefinitions="Auto,*">
            <!-- Menu Header -->
            <Grid Grid.Row="0" Margin="0,0,0,16">
              <TextBlock Text="{Binding Localizer[Menu]}"
                        FontSize="20"
                        FontWeight="SemiBold"
                        HorizontalAlignment="Center"/>
              <Button Content="{iconPacks:Material Close}"
                     FontSize="20"
                     HorizontalAlignment="Right"
                     VerticalAlignment="Center"
                     Background="Transparent"
                     BorderThickness="0"
                     Padding="8"
                     Click="CloseMenu_OnClick"/>
            </Grid>
            
            <!-- Menu Items Grid (4x4 grid with padding) -->
            <Grid Grid.Row="1" Margin="16">
              <ItemsControl ItemsSource="{Binding MenuItems}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <UniformGrid Rows="4" Columns="4"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate DataType="services:MenuItem">
                    <Border Background="Transparent"
                            BorderThickness="0"
                            Padding="4">
                      <Button Background="Transparent"
                              BorderThickness="0"
                              Padding="0"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Stretch"
                              Command="{Binding SelectedCommand, FallbackValue={x:Null}}"
                              CommandParameter="{Binding}">
                        <StackPanel Spacing="6" HorizontalAlignment="Center" VerticalAlignment="Center">
                          <iconPacks:PackIconMaterial Kind="{Binding IconKind}"
                                                     Width="28"
                                                     Height="28"
                                                     HorizontalAlignment="Center"/>
                          <TextBlock Text="{Binding Title.Text}"
                                    FontSize="11"
                                    TextAlignment="Center"
                                    TextWrapping="Wrap"
                                    MaxWidth="70"/>
                        </StackPanel>
                      </Button>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </Grid>
          </Grid>
        </Border>
      </Border>
    </Grid>
  </Grid>
</UserControl>
