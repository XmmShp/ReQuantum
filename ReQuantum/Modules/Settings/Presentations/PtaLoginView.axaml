<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewModels="clr-namespace:ReQuantum.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="ReQuantum.Views.PtaLoginView"
             x:DataType="viewModels:PtaLoginViewModel">
  <Design.DataContext>
    <viewModels:PtaLoginViewModel />
  </Design.DataContext>

  <StackPanel Spacing="16">
      <!-- Login Form (visible when not logged in) -->
      <StackPanel Spacing="16" IsVisible="{Binding !IsLoggedIn}">

        <!-- Mode Switcher -->
        <Border CornerRadius="8" HorizontalAlignment="Center" ClipToBounds="True" 
                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1">
            <StackPanel Orientation="Horizontal">
                <Button Content="å¯†ç ç™»å½•" 
                        Command="{Binding SwitchToPasswordModeCommand}" 
                        IsEnabled="{Binding IsQrLoginMode}"
                        CornerRadius="0"
                        Padding="20,10"/>
                <Button Content="å¾®ä¿¡æ‰«ç " 
                        Command="{Binding SwitchToQrLoginCommand}" 
                        IsEnabled="{Binding !IsQrLoginMode}"
                        CornerRadius="0"
                        Padding="20,10"/>
            </StackPanel>
        </Border>

        <!-- Password Login Form -->
        <Border IsVisible="{Binding !IsQrLoginMode}"
                BorderThickness="1"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                CornerRadius="8"
                Padding="20">
          <StackPanel Spacing="16">
            <TextBlock Text="{Binding Localizer[PtaAccountLogin]}"
                       FontSize="18"
                       FontWeight="SemiBold"
                       HorizontalAlignment="Center"/>

            <!-- Email Input -->
            <StackPanel Spacing="8">
              <TextBlock Text="{Binding Localizer[Email]}"
                         FontSize="14"
                         FontWeight="Medium"/>
              <TextBox Text="{Binding Email}"
                       Watermark="{Binding Localizer[EnterPtaEmail]}"
                       FontSize="14"
                       Padding="12,8"/>
            </StackPanel>

            <!-- Password Input -->
            <StackPanel Spacing="8">
              <TextBlock Text="{Binding Localizer[Password]}"
                         FontSize="14"
                         FontWeight="Medium"/>
              <TextBox Text="{Binding Password}"
                       PasswordChar="â—"
                       Watermark="{Binding Localizer[EnterPassword]}"
                       FontSize="14"
                       Padding="12,8"/>
            </StackPanel>

            <!-- Captcha Section -->
            <Border IsVisible="{Binding IsCaptchaVisible}" 
                    Background="{DynamicResource SystemControlBackgroundBaseLowBrush}" 
                    Padding="15" CornerRadius="6">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="âš " Foreground="Orange" VerticalAlignment="Center"/>
                        <TextBlock Text="éœ€è¦å®‰å…¨éªŒè¯" FontWeight="Bold" VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <Image Source="{Binding CaptchaBitmap}" Height="60" HorizontalAlignment="Left"/>
                    
                    <Grid ColumnDefinitions="*, Auto">
                        <TextBox Text="{Binding CaptchaCode}" Watermark="è¯·è¾“å…¥å›¾ä¸­çš„å­—ç¬¦" Margin="0,0,10,0"/>
                        <Button Grid.Column="1" Command="{Binding SubmitCaptchaCommand}" Content="æäº¤éªŒè¯"/>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Status Message -->
            <TextBlock Text="{Binding StatusMessage}"
                       FontSize="12"
                       Foreground="{DynamicResource SystemControlErrorTextForegroundBrush}"
                       TextWrapping="Wrap"
                       HorizontalAlignment="Center"
                       IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

            <!-- Login Button -->
            <Button Command="{Binding LoginCommand}"
                    HorizontalAlignment="Stretch"
                    Padding="16,12"
                    IsVisible="{Binding !IsCaptchaVisible}"
                    IsEnabled="{Binding !IsLoading}">
              <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <TextBlock Text="ðŸ”" FontSize="16" IsVisible="{Binding !IsLoading}"/>
                <TextBlock Text="{Binding Localizer[Login]}"
                           FontSize="14"
                           FontWeight="SemiBold"
                           IsVisible="{Binding !IsLoading}"/>
                <TextBlock Text="{Binding Localizer[LoggingIn]}"
                           FontSize="14"
                           FontWeight="SemiBold"
                           IsVisible="{Binding IsLoading}"/>
              </StackPanel>
            </Button>
            
            <Button Command="{Binding OpenBrowserLoginCommand}"
                    Content="{Binding Localizer[PtaManualPasteSession]}"
                    Classes="theme-transparent"
                    FontSize="12"
                    HorizontalAlignment="Center"
                    Opacity="0.7"/>
          </StackPanel>
        </Border>

        <!-- QR Login Form -->
        <Border IsVisible="{Binding IsQrLoginMode}"
                BorderThickness="1"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                CornerRadius="8"
                Padding="20"
                MinHeight="300">
            <StackPanel Spacing="20" HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="{Binding Localizer[PtaScanWithWeChat]}" FontSize="16" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                
                <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" 
                        BorderThickness="1" CornerRadius="4" Padding="10" Background="White">
                    <Panel Width="200" Height="200">
                        <Image Source="{Binding QrCodeBitmap}" 
                               IsVisible="{Binding QrCodeBitmap, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                        
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                                    IsVisible="{Binding QrCodeBitmap, Converter={x:Static ObjectConverters.IsNull}}">
                            <ProgressBar IsIndeterminate="True"/>
                            <TextBlock Text="æ­£åœ¨åŠ è½½äºŒç»´ç ..." Margin="0,10,0,0" FontSize="12"/>
                        </StackPanel>
                    </Panel>
                </Border>

                <TextBlock Text="{Binding StatusMessage}" 
                           HorizontalAlignment="Center" 
                           TextWrapping="Wrap"
                           MaxWidth="250"
                           TextAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Cookie Input (visible when ShowCookieInput is true) -->
        <Border BorderThickness="1"
                BorderBrush="Orange"
                CornerRadius="8"
                Padding="20"
                IsVisible="{Binding ShowCookieInput}">
          <StackPanel Spacing="16">
            <TextBlock Text="{Binding Localizer[EnterPtaSessionCookie]}"
                       FontSize="16"
                       FontWeight="SemiBold"
                       HorizontalAlignment="Center"/>

            <TextBlock Text="{Binding DebugInfo}"
                       FontFamily="Consolas"
                       FontSize="11"
                       TextWrapping="Wrap"
                       Opacity="0.7"
                       Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                       Padding="12"/>

            <TextBox Text="{Binding PtaSessionInput}"
                     Watermark="{Binding Localizer[PastePtaSessionValue]}"
                     FontSize="12"
                     FontFamily="Consolas"
                     Padding="12,8"/>

            <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
              <Button Command="{Binding SubmitCookieCommand}"
                      Padding="24,10">
                <TextBlock FontSize="14"
                           FontWeight="SemiBold">
                  <Run Text="âœ“ "/>
                  <Run Text="{Binding Localizer[Submit]}"/>
                </TextBlock>
              </Button>
              <Button Command="{Binding CancelCookieInputCommand}"
                      Padding="24,10">
                <TextBlock FontSize="14">
                  <Run Text="âœ• "/>
                  <Run Text="{Binding Localizer[Cancel]}"/>
                </TextBlock>
              </Button>
            </StackPanel>
          </StackPanel>
        </Border>

      </StackPanel>

      <!-- Logged In Status (visible when logged in) -->
      <StackPanel Spacing="16" IsVisible="{Binding IsLoggedIn}">
        <Border BorderThickness="1"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                CornerRadius="8"
                Padding="20"
                HorizontalAlignment="Center">
          <StackPanel Spacing="12">
            <TextBlock FontSize="18"
                       FontWeight="Bold"
                       Foreground="Green"
                       HorizontalAlignment="Center">
              <Run Text="âœ“ "/>
              <Run Text="{Binding Localizer[PtaLoggedIn]}"/>
            </TextBlock>

            <TextBlock Text="{Binding StatusMessage}"
                       FontSize="14"
                       Opacity="0.8"
                       HorizontalAlignment="Center"
                       IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
          </StackPanel>
        </Border>

        <!-- Logout Button -->
        <Button Command="{Binding LogoutCommand}"
                HorizontalAlignment="Center"
                Padding="24,12">
          <TextBlock Text="{Binding Localizer[Logout]}"
                     FontSize="14"
                     FontWeight="SemiBold"/>
        </Button>
      </StackPanel>

  </StackPanel>
</UserControl>